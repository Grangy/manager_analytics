# AI Analytics — Аналитика менеджеров

Веб-приложение для аналитики заказов и рабочего времени менеджеров. Дашборд выручки, KPI, графики по часам и регионам. Раздел «Рабочее время» — анализ начала/конца рабочего дня по первому и последнему заказу, опоздания, сводка по менеджерам.

## Технологии

- **Next.js 16** (App Router)
- **Prisma** + **SQLite**
- **Recharts** — графики
- **Tailwind CSS**
- **xlsx** — импорт из Excel

## Возможности

### Дашборд
- Выручка, количество заказов, средний чек
- Распределение по часам и регионам
- Фильтры: вчера / неделя / месяц / свой период

### Рабочее время
- Среднее начало и конец дня (по первому и последнему заказу)
- Минимальное и максимальное время за период
- Опоздания (начало после 10:00)
- Сводка по менеджерам с фильтрами и сортировкой
- Модальное окно со всеми заказами менеджера
- Графики и разбивка по дням недели

## Быстрый старт

### Установка

```bash
npm install
npx prisma generate
```

### Миграция и данные

```bash
# Создать БД и применить схему
npx prisma migrate dev

# Импорт заказов из Excel (файл Заказы.xlsx в корне проекта)
npm run import

# Или указать свой файл
node scripts/import-orders.js /path/to/orders.xlsx
```

### Формат Excel

Скрипт ожидает файл с колонками (строка 0 — заголовок, данные с 5-й строки):

| A          | B | C (дата) | D | E (время) | F (сумма) | G–M |
|------------|---|----------|---|-----------|-----------|-----|
| № заказа   | … | 12.02.2025 | … | 9:42:17  | 15000    | …   |
| …          | … | …        | … | …         | …         | M (менеджер) |

Формат даты: `ДД.ММ.ГГГГ`. Менеджер — колонка J (индекс 9).

### Запуск

```bash
# Разработка
npm run dev

# Продакшен (сначала собрать!)
npm run build
npm start
```

Приложение доступно на [http://localhost:3000](http://localhost:3000). Продакшен — на порту 7732.

### Деплой на сервер

После `git clone` и `npm install` на сервере:

```bash
npx prisma migrate deploy   # создать БД
npm run import              # импорт из Excel (если есть файл)
npm run build               # собрать приложение
npm start                   # запуск на порту 7732
```

### Автоимпорт заказов из 1C (cron 21:00)

Файлы заказов поступают в `/home/ftp1c/upload/` в 20:00. Для автоматической обработки в 21:00:

1. Добавить в cron: `crontab -e`
   ```
   0 21 * * * cd /var/www/manager_analytics && npm run process-orders >> /var/log/process-orders.log 2>&1
   ```

2. Переменная `UPLOAD_DIR` (опционально): по умолчанию `/home/ftp1c/upload`

3. Скрипт: ищет `.zip`, переименовывает (фикс кириллицы CP1251), распаковывает, импортирует Excel в БД, сохраняет в `upload/archive/`, оставляет только 5 последних архивов.

## Структура проекта

```
├── prisma/
│   ├── schema.prisma    # Схема БД (Order)
│   ├── analytics.db     # SQLite (создаётся миграцией, не в git)
│   └── migrations/
├── scripts/
│   ├── import-orders.js       # Ручной импорт из Excel
│   └── process-uploaded-orders.js  # Cron: импорт из upload (1C)
├── src/
│   ├── app/
│   │   ├── login/       # Страница входа
│   │   ├── page.tsx     # Дашборд
│   │   ├── rabochhee-vremya/
│   │   │   └── page.tsx # Рабочее время
│   │   ├── api/        # API routes
│   │   └── components/
│   └── lib/
│       ├── prisma.ts
│       └── working-hours.ts  # Логика рабочего времени
└── tests/
    └── working-hours.test.ts
```

## Скрипты

| Команда          | Описание                    |
|------------------|-----------------------------|
| `npm run dev`    | Запуск в режиме разработки  |
| `npm run build`  | Сборка для продакшена       |
| `npm run start`  | Запуск продакшен-сервера    |
| `npm run import` | Импорт заказов из Excel     |
| `npm run process-orders` | Импорт из папки загрузок (1C, cron) |
| `npm run reimport-archive` | Переимпорт из архивов (исправление кодировки) |
| `npm run fix-encoding` | Попытка исправить кодировку в БД |
| `npm run test`   | Запуск тестов               |
| `npm run lint`   | Проверка линтером           |

## Авторизация

- Вход по паролю (проверяется на сервере)
- Сессия хранится в `localStorage`
- 10 неверных попыток — блокировка на 24 часа (тоже в `localStorage`)
- Пароль задаётся через `AUTH_PASSWORD` в `.env` (по умолчанию: `22170313`)

## Важно

- **База данных** (`prisma/analytics.db`) и **Excel-файлы** не попадают в репозиторий — см. `.gitignore`
- Перед первым запуском нужно выполнить миграцию и импорт
- Выходные (сб, вс) исключаются из анализа рабочего дня

## Лицензия

Частный проект.
